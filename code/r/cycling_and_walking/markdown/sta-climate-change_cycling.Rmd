---
title: "STA Climate Change &ndash; Cycling"
output:
#  html_document:
#    toc: true
#    toc_depth: 3
#    toc_float: true
    
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: bootstrap
    social: menu
 #   source_code: embed
    
---

<style>
  table {
    border-bottom: 1px solid #333;
  }
</style>

```{r global-options, include = FALSE, cache = FALSE}

knitr::opts_chunk$set(out.width = '100%', out.height = '100%', fig.align = 'left',
                      echo = FALSE, warning = FALSE, message = FALSE)

# fig.dim = c(12, 5),

```

```{r libraries_and_utilities}

source("base/common-traffic_counters.r")
source("base/common_interaction.r")

## the following libraries called in sourced base files
#library(tidyverse)
#library(lubridate)
##library(ggtext)
#library(DBI)

#library(plotly)
#library(crosstalk)

library(knitr)
library(kableExtra)


# utilities & c.

knitr::read_chunk("base/cycle_counters_interactive.r")

```

```{r sqa_data_extraction, cache = TRUE}

#source("base/sta_climate_change_sql_extract.r", local = knitr::knit_global())
load("cycling_datasets.Rdata")  #interim - querying and parsing from scratch
source("base/sta_climate_change_data_parsing.r", local = knitr::knit_global())

```


Overview 
=======================================================================

Row {data-height=75}
-------------------------------------
   
### Starting with the installation of 11 bicycle and pedestrian counters by Cycling Scotland's National Monitoring Framework (NMF) in a number of counties predominantly in west, central Scotland, from June 2017 and through to Aug 2020, when the 63rd counter was installed in Fort William in the Highlands, and a further three in Edinburgh in Jun and Jul 2021. The snapshots now also include data from more dense networks of council-managed counters and some points along the John Muir Way.


Column {data-height=700}
-----------------------------------------------------------------------

### Cyclists &ndash; Total Count by Month &amp; Year, All Bicycle Counters
```{r, bicycle_counts}
```

### Pedestrians &ndash; Total Count by Month &amp; Year, NMF Counters
```{r, pedestrian_counts_nmf}
```


Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Counter Data Summaries

#### NMF Counters

```{r, summary_tables_nmf, results = 'asis'}
```

```{=html}
<p>&nbsp;<br />
Focusing on the NMF counters, at end Sep 2021 over <b>5m bikes</b> and <b>21m pedestrians</b> had been recorded going past all counters.
Average count per day dropped in 2018 for both types of counters before starting to rise again. Looking at counts overall, <b>cycling peaked in May 2020</b>, two months after the first COVID-19 lockdown was imposed, then continued to drop after plateauing over the summer. Despite further restrictions <b>in 2021 cycling dropped overall</b>. Walking, overall, however continued to rise in 2021. But even this started to decrease in April, and by June had dropped below the same month in 2020. However, both cycling and walking started to rise again in Jul 2021, both over the 2020 figures, but then fell again in Aug, rising only slightly in Sep.
</p>
<p>
The data now also includes council-managed counters. However, the much larger number of counters and denser network in the two largest cities, Edinburgh and Glasgow, skew the data, especially when looking at totals. We therefore compare data across location and time using predominantly average counts.
</p>

<p>&nbsp;<br />
</p>
```


#### Council Counters &amp; the John Muir Way

```{r, summary_tables_councils, results = 'asis'}
```


### Counter Locations

####
```{=html}
<p>All counters &ndash; NMF and council-managed, showing installation dates and count per location. It should be noted that there is some delay between counter installation and the point from which data is recorded. Counters that came online within the last month or two may therefore not have any data reported in charts shown. Occasionally, also, a counter may go out of action temporarily and sometimes for significant periods of time.
</p>
```

####

```{r, counters_installed, fig.height = 8, fig.width = 10}
```


Cycling through the Week {data-navmenu="Exploring the Data"}
=======================================================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

```{r, filtered_data_counts_time_of_day_by_year_and_weekday}
```

### Cycling &ndash; Changes through the Week

```{r, avg_count_time_of_day_by_weekday_and_year}
```

### Change over Time &ndash; Cycling through the Week

```{r, avg_count_time_of_day_by_year_and_weekday}
```

`r rm(filtered_data) `


Cycling through the Year {data-navmenu="Exploring the Data"}
=======================================================================

> Comparing total counts for each data provider and location against averages per hour through the day... this gets more interesting looking at the data month on month, as we can see how cycling changes through the full period for which counters were installed and working. (Note - where the picture is blank no data exists for a provider for that period.)



Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

```{r, filtered_data_counts_time_of_day_by_month_and_year}
```

### Average Monthly Count

```{r, average_count_time_of_day_by_month_and_year}
```

### Monthly Totals

```{r, total_count_time_of_day_by_month_and_year}
```

`r rm(filtered_data) `


Variation across Locations {data-navmenu="Exploring the Data"}
=======================================================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### By Year

```{r, average_count_by_location_and_year}
```

### By Month

```{r, average_count_by_location_and_month}
```


As the Seasons Change {data-navmenu="Exploring the Data"}
=======================================================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Monthly Counts per Location

#### Monthly Totals - As the Seasons Change

```{r, total_count_by_location_and_month}
```

```{=html}
  <p>&nbsp;<br />"</p>
```

---

#### Rainfall Patterns (mm) - Scotland

```{r, historical_weather_scotland_rainfall}
```

#### Temperature Patterns (C) - Scotland

```{r, historical_weather_scotland_temp}
```

### Changes in Counts by Year

```{r, total_count_by_location_grouped_by_year}
```



Peak Counts {data-navmenu="Data Stories"}
=======================================================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

>Counts vary from 0 to, occasionally, for cyclists, well over 20K within an hour and almost 70K in a single day. The tables below give a feel for when spikes occurred within each dataset; in East Dunbartonshire the peak hourly count occurs on the day with the peak count. Any or all of day of the week, time of day and month in the year, and recent weather patterns, road type, in addition to a specific event in a location contribute to variation in numbers of especially cyclists in a location.


### Peak Counts

```{r, summary_tables_max_counts_hourly, results = 'asis'}
```

```{=html}
  <p>&nbsp;<br /></p>
  
```

```{r, summary_tables_max_counts_daily, results = 'asis'}
```


Lerwick &ndash; Change through the Seasons {data-navmenu="Data Stories"}
=======================================================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Lerwick &ndash; Change through the Seasons

#### Monthly Totals - As the Seasons Change

```{r, total_count_by_location_and_month_lerwick}
```

```{=html}
  <p>&nbsp;<br />"</p>
```
---


#### Rainfall Patterns (mm) - Lerwick, Shetland

```{r, historical_weather_lerwick_rainfall}
```

#### Temperature Patterns (C) - Lerwick, Shetland

```{r, historical_weather_lerwick_temp}
```

`r rm(counter_start, roadNames) `



About
=======================================================================

> About ...

Row
-----------------------------------------------------------------------

```{=html}
<p>&nbsp;<br />
<!-- A summary sheet may be downloaded &ndash; <a href="cycle_counters_info_cards.pdf">cycle_counters_info_cards.pdf</a -->

Counter data may be accessed via Cycling Scotland's <a href = "https://usmart.io/org/cyclingscotland/" target = "_blank">Active Travel Open Data Portal</a>.

The data used in the analysis presented was accessed via the API at the level of detail for both pedestrian and cycle counters operated under Cycling Scotland's National Monitoring Framework. To use the API you must register and request an API key. Alternatively, a <a href= "https://usmart.io/org/cyclingscotland/discovery/discovery-view-detail/7ffbe5d6-fa13-4352-829d-0bb0a58e3355" target = "_blank">dump may be downloaded</a> from the portal.


<!--
City of Edinburgh Council - Daily cycling counts from automatic cycling counters
https://usmart.io/org/cyclingscotland/discovery/discovery-view-detail/b1f0bd42-e220-465e-99a3-c4f62824f21f

National Monitoring Framework - all-mode traffic survey results 2017 to 2021 - Cycling Scotland
https://usmart.io/org/cyclingscotland/discovery/discovery-view-detail/b9fdd462-1f45-4252-aedc-fbc596abcd90
-->
<br /><br />

<a href = "https://www.metoffice.gov.uk/research/climate/maps-and-data/uk-and-regional-series" target = "_blank">Historical weather pattern data</a> was obtained from the Met Office.

</p>

```
